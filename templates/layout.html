<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}AI Stock Analyzer{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@alpinejs/intersect@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/relativeTime.js"></script>
    <script>dayjs.extend(window.dayjs_plugin_relativeTime)</script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0D1117;
            color: #C9D1D9;
        }
        .glass-card {
            background: rgba(22, 27, 34, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(48, 54, 61, 0.5);
        }
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="min-h-screen">
    <header class="bg-[#161B22] border-b border-[#30363D] p-4 sticky top-0 z-50" x-data="{ mobileMenuOpen: false }">
        <div class="container mx-auto flex justify-between items-center">
            <a href="{{ url_for('home') }}" class="text-2xl font-bold text-white flex items-center gap-2">
                <i class="fa-solid fa-robot text-cyan-400"></i>
                <span>AI Analyzer</span>
            </a>

            <nav class="hidden md:flex items-center gap-4">
                <a href="{{ url_for('home') }}" class="text-gray-300 hover:text-white transition-colors">Home</a>
                <a href="{{ url_for('about') }}" class="text-gray-300 hover:text-white transition-colors">About</a>
                <a href="{{ url_for('contact') }}" class="text-gray-300 hover:text-white transition-colors">Contact</a>

                {% if current_user.is_authenticated and current_user.is_admin %}
                <a href="{{ url_for('admin.dashboard') }}" class="text-cyan-400 font-bold hover:text-white transition-colors">
                    <i class="fas fa-user-shield"></i> Admin
                </a>
                {% endif %}
                
                {% if current_user.is_authenticated %}
                <!-- FEAT: Notification Bell -->
                <!-- <div x-data="notificationHandler()" class="relative">
                    <button @click="toggle" class="text-gray-300 hover:text-white transition-colors relative">
                        <i class="fas fa-bell"></i>
                        <span x-show="unreadCount > 0" x-text="unreadCount" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-4 w-4 flex items-center justify-center text-[10px]"></span>
                    </button>
                    <div x-show="open" @click.away="open = false" x-transition x-cloak class="absolute right-0 mt-2 w-80 bg-[#0D1117] border border-[#303D3D] rounded-lg shadow-xl z-20 max-h-96 overflow-y-auto">
                        <div class="p-3 font-bold text-white border-b border-[#303D3D]">Notifications</div>
                        <template x-if="notifications.length > 0">
                            <div>
                                <template x-for="notification in notifications" :key="notification.id">
                                    <div class="p-3 border-b border-[#303D3D] hover:bg-[#161B22]">
                                        <p class="text-sm" :class="!notification.is_read ? 'text-white' : 'text-gray-400'" x-text="notification.message"></p>
                                        <p class="text-xs text-gray-500 mt-1" x-text="dayjs(notification.timestamp).fromNow()"></p>
                                    </div>
                                </template>
                            </div>
                        </template>
                        <template x-if="notifications.length === 0">
                            <p class="p-4 text-center text-gray-500">No notifications yet.</p>
                        </template>
                    </div>
                </div>
                {% endif %} -->

                <div x-data="{ open: false }" class="relative">
                    <button @click="open = !open" @click.away="open = false" class="flex items-center gap-2 text-gray-300 hover:text-white transition-colors">
                        My Account
                        <i class="fa-solid fa-caret-down fa-xs transition-transform" :class="{'rotate-180': open}"></i>
                    </button>
                    <div x-show="open" x-transition x-cloak class="absolute right-0 mt-2 w-56 bg-[#0D1117] border border-[#303D3D] rounded-lg shadow-xl z-20">
                        {% if current_user.is_authenticated %}
                            <div class="px-4 py-3 border-b border-[#303D3D]">
                                <p class="text-sm text-white">Signed in as</p>
                                <p class="text-sm font-medium text-white truncate">{{ current_user.username }}</p>
                            </div>
                            <a href="{{ url_for('account') }}" class="block px-4 py-2 text-sm text-gray-300 hover:bg-[#303D3D]"><i class="fa-solid fa-user-circle w-4 mr-2"></i> Profile</a>
                            <a href="{{ url_for('history') }}" class="block px-4 py-2 text-sm text-gray-300 hover:bg-[#303D3D]"><i class="fa-solid fa-history w-4 mr-2"></i> History</a>
                            <div class="px-4 py-2 text-sm text-amber-400 flex items-center border-t border-[#303D3D]"><i class="fa-solid fa-coins w-4 mr-2"></i> <span id="user-coins-display">{{ current_user.coins }}</span>&nbsp;Coins</div>
                            <a href="{{ url_for('logout') }}" class="block w-full text-left px-4 py-2 text-sm text-red-400 hover:bg-[#303D3D] border-t border-[#303D3D]"><i class="fa-solid fa-sign-out-alt w-4 mr-2"></i> Logout</a>
                        {% else %}
                            <a href="{{ url_for('login') }}" class="block px-4 py-2 text-sm text-gray-300 hover:bg-[#303D3D]"><i class="fa-solid fa-sign-in-alt w-4 mr-2"></i> Login</a>
                            <a href="{{ url_for('register') }}" class="block px-4 py-2 text-sm text-gray-300 hover:bg-[#303D3D]"><i class="fa-solid fa-user-plus w-4 mr-2"></i> Register</a>
                        {% endif %}
                    </div>
                </div>
            </nav>

            <div class="md:hidden">
                <button @click="mobileMenuOpen = !mobileMenuOpen" class="text-white focus:outline-none">
                    <i class="fas" :class="mobileMenuOpen ? 'fa-times' : 'fa-bars'"></i>
                </button>
            </div>
        </div>

        <div x-show="mobileMenuOpen" x-cloak class="md:hidden mt-4">
            <nav class="flex flex-col gap-4">
                <a href="{{ url_for('home') }}" class="text-gray-300 hover:text-white transition-colors">Home</a>
                <a href="{{ url_for('about') }}" class="text-gray-300 hover:text-white transition-colors">About</a>
                <a href="{{ url_for('contact') }}" class="text-gray-300 hover:text-white transition-colors">Contact</a>
                <hr class="border-gray-700">
                {% if current_user.is_authenticated %}
                    {% if current_user.is_admin %}
                        <a href="{{ url_for('admin.dashboard') }}" class="text-cyan-400 font-bold hover:text-white transition-colors">Admin Panel</a>
                    {% endif %}
                    <a href="{{ url_for('account') }}" class="text-gray-300 hover:text-white">My Account</a>
                    <a href="{{ url_for('history') }}" class="text-gray-300 hover:text-white">History</a>
                    <a href="{{ url_for('logout') }}" class="text-red-400 hover:text-red-300">Logout</a>
                {% else %}
                    <a href="{{ url_for('login') }}" class="text-gray-300 hover:text-white">Login</a>
                    <a href="{{ url_for('register') }}" class="text-gray-300 hover:text-white">Register</a>
                {% endif %}
            </nav>
        </div>
    </header>

    <main class="container mx-auto p-4 md:p-8">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% set style_map = {
                    'info': 'bg-blue-500/10 border-blue-500/30 text-blue-300',
                    'success': 'bg-green-500/10 border-green-500/30 text-green-300',
                    'danger': 'bg-red-500/10 border-red-500/30 text-red-300',
                    'warning': 'bg-yellow-500/10 border-yellow-500/30 text-yellow-300'
                } %}
                {% for category, message in messages %}
                    <div class="{{ style_map.get(category, style_map['info']) }} px-4 py-3 rounded-lg relative mb-6" role="alert">
                      <strong class="font-bold">{{ category|title }}!</strong>
                      <span class="block sm:inline">{{ message }}</span>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        {% block content %}{% endblock %}
    </main>

    <footer class="text-center p-4 mt-8 text-gray-500 text-sm">
        <p>Disclaimer: This is an AI-generated analysis and not financial advice.</p>
        <p>&copy; 2025 AI Stock Analyzer. All Rights Reserved.</p>
    </footer>

<script>
document.addEventListener('alpine:init', () => {
    // FEAT: Alpine component to handle notifications
    Alpine.data('notificationHandler', () => ({
        open: false,
        notifications: [],
        unreadCount: 0,
        init() {
            this.fetchNotifications();
            // Refresh notifications every minute
            setInterval(() => this.fetchNotifications(), 60000);
        },
        fetchNotifications() {
            fetch('{{ url_for("get_notifications") }}')
                .then(res => res.json())
                .then(data => {
                    this.notifications = data.notifications;
                    this.unreadCount = data.unread_count;
                })
                .catch(err => console.error('Failed to fetch notifications:', err));
        },
        toggle() {
            this.open = !this.open;
            if (this.open && this.unreadCount > 0) {
                this.markAsRead();
            }
        },
        markAsRead() {
            fetch('{{ url_for("mark_notifications_read") }}', { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        this.unreadCount = 0;
                        this.notifications.forEach(n => n.is_read = true);
                    }
                })
                .catch(err => console.error('Failed to mark notifications as read:', err));
        }
    }));
});
</script>
</body>
</html>
